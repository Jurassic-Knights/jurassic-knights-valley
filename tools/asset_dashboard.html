<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Management Dashboard</title>
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-panel: #16213e;
            --bg-card: #0f3460;
            --accent: #e94560;
            --accent-green: #4ecca3;
            --accent-yellow: #ffc107;
            --text: #eaeaea;
            --text-dim: #8892b0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }

        header {
            background: var(--bg-panel);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--accent);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            font-size: 1.5rem;
            color: var(--accent);
        }

        .controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        button.secondary {
            background: var(--bg-card);
            border: 1px solid var(--text-dim);
        }

        button.approve {
            background: var(--accent-green);
        }

        button.decline {
            background: var(--accent);
        }

        button.process {
            background: var(--accent-yellow);
            color: #000;
        }

        .stats {
            display: flex;
            gap: 2rem;
            padding: 1rem 2rem;
            background: var(--bg-panel);
            flex-wrap: wrap;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-label {
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        .stat.pending .stat-value {
            color: var(--accent-yellow);
        }

        .stat.approved .stat-value {
            color: var(--accent-green);
        }

        .stat.declined .stat-value {
            color: var(--accent);
        }

        .stat.clean .stat-value {
            color: #64b5f6;
        }

        .filters {
            padding: 1rem 2rem;
            background: var(--bg-dark);
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            border-radius: 20px;
        }

        .filter-btn.active {
            box-shadow: 0 0 0 2px white;
        }

        main {
            padding: 2rem;
        }

        .category {
            margin-bottom: 2rem;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--bg-card);
        }

        .category-title {
            font-size: 1.2rem;
            color: var(--accent);
            text-transform: capitalize;
        }

        .asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }

        .asset-card {
            background: var(--bg-card);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .asset-card.declined {
            opacity: 0.5;
        }

        .asset-card.approved {
            box-shadow: 0 0 0 3px var(--accent-green);
        }

        .asset-card.pending {
            box-shadow: 0 0 0 2px var(--accent-yellow);
        }

        .asset-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: contain;
            background: repeating-conic-gradient(#333 0% 25%, #222 0% 50%) 50% / 20px 20px;
            cursor: pointer;
        }

        .asset-info {
            padding: 0.75rem;
        }

        .asset-name {
            font-size: 0.75rem;
            word-break: break-all;
            margin-bottom: 0.5rem;
            color: var(--text-dim);
        }

        .asset-status {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: var(--accent-yellow);
            color: #000;
        }

        .status-approved {
            background: var(--accent-green);
            color: #000;
        }

        .status-declined {
            background: var(--accent);
            color: #fff;
        }

        .status-clean {
            background: #64b5f6;
            color: #000;
        }

        .status-unknown {
            background: var(--text-dim);
            color: #000;
        }

        .asset-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .asset-actions button {
            flex: 1;
            padding: 0.3rem;
            font-size: 0.7rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .modal.active {
            display: flex;
        }

        .modal img {
            max-width: 90%;
            max-height: 80%;
            object-fit: contain;
        }

        .modal-info {
            color: white;
            margin-top: 1rem;
            text-align: center;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 2rem;
            color: white;
            cursor: pointer;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-dim);
        }

        .error {
            background: var(--accent);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 2rem;
        }

        .instructions {
            background: var(--bg-panel);
            padding: 1rem;
            border-radius: 8px;
            margin: 0 2rem 1rem;
        }

        .instructions code {
            background: var(--bg-dark);
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <header>
        <h1>ü¶ñ Asset Management Dashboard</h1>
        <div class="controls">
            <button id="btnRefresh" class="secondary">üîÑ Refresh Manifest</button>
            <button id="btnEnableEdit" class="secondary">‚úèÔ∏è Enable Editing</button>
        </div>
    </header>

    <div class="stats">
        <div class="stat pending">
            <span class="stat-value" id="statPending">-</span>
            <span class="stat-label">Pending</span>
        </div>
        <div class="stat approved">
            <span class="stat-value" id="statApproved">-</span>
            <span class="stat-label">Approved</span>
        </div>
        <div class="stat declined">
            <span class="stat-value" id="statDeclined">-</span>
            <span class="stat-label">Declined</span>
        </div>
        <div class="stat clean">
            <span class="stat-value" id="statClean">-</span>
            <span class="stat-label">Clean</span>
        </div>
    </div>

    <div class="filters">
        <button class="filter-btn secondary active" data-filter="all">All</button>
        <button class="filter-btn secondary" data-filter="pending">Pending</button>
        <button class="filter-btn secondary" data-filter="approved">Approved</button>
        <button class="filter-btn secondary" data-filter="declined">Declined</button>
        <button class="filter-btn secondary" data-filter="clean">Clean</button>
    </div>

    <div class="instructions" id="editInstructions" style="display: none;">
        <strong>Edit Mode:</strong> Click "Enable Editing" and select the <code>assets/images</code> folder to enable
        approve/decline buttons.
        After making changes, run: <code>python scripts/generate_asset_manifest.py</code> to refresh.
    </div>

    <main id="mainContent">
        <div class="loading">Loading assets...</div>
    </main>

    <div class="modal" id="imageModal">
        <span class="modal-close" onclick="closeModal()">√ó</span>
        <img id="modalImage" src="" alt="Preview">
        <div class="modal-info" id="modalInfo"></div>
    </div>

    <div class="modal" id="declineModal">
        <div style="background: var(--bg-panel); padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%;">
            <h3 style="color: var(--accent); margin-bottom: 1rem;">Decline Asset</h3>
            <p style="color: var(--text-dim); margin-bottom: 1rem;">Asset: <strong id="declineAssetName"></strong></p>
            <label style="color: var(--text); display: block; margin-bottom: 0.5rem;">Regeneration Instructions
                (optional):</label>
            <textarea id="declineNotes" rows="4"
                style="width: 100%; background: var(--bg-dark); color: var(--text); border: 1px solid var(--text-dim); border-radius: 4px; padding: 0.5rem; font-family: inherit;"
                placeholder="e.g., Make it more rusty, change angle to horizontal, add more detail..."></textarea>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button class="decline" onclick="confirmDecline()">‚úó Confirm Decline</button>
                <button class="secondary" onclick="closeDeclineModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script src="asset_manifest.js"></script>
    <script>
        let manifest = window.ASSET_MANIFEST || null;
        let currentFilter = 'all';
        let editMode = false;
        let rootHandle = null;
        let manifestFileHandle = null;

        const BASE_PATH = '../assets/images/';

        function loadManifest() {
            if (!manifest) {
                document.getElementById('mainContent').innerHTML = `
                    <div class="error">
                        <strong>Could not load asset manifest.</strong><br>
                        Run: <code>python scripts/generate_asset_manifest.py</code>
                    </div>
                `;
                return;
            }
            renderAssets();
            updateStats();
        }

        function renderAssets() {
            const container = document.getElementById('mainContent');
            container.innerHTML = '';

            if (!manifest || !manifest.assets) return;

            // Group by category
            const categories = {};
            manifest.assets.forEach(asset => {
                // Apply filter
                if (currentFilter !== 'all' && asset.status !== currentFilter) return;

                if (!categories[asset.category]) {
                    categories[asset.category] = [];
                }
                categories[asset.category].push(asset);
            });

            // Sort categories
            const sortedCategories = Object.keys(categories).sort();

            for (const category of sortedCategories) {
                const assets = categories[category];

                const categoryEl = document.createElement('div');
                categoryEl.className = 'category';
                categoryEl.innerHTML = `
                    <div class="category-header">
                        <h2 class="category-title">${category}</h2>
                        <span style="color: var(--text-dim)">${assets.length} assets</span>
                    </div>
                    <div class="asset-grid"></div>
                `;
                container.appendChild(categoryEl);

                const grid = categoryEl.querySelector('.asset-grid');
                assets.forEach(asset => {
                    grid.appendChild(createAssetCard(asset));
                });
            }

            if (sortedCategories.length === 0) {
                container.innerHTML = '<div class="loading">No assets match the current filter.</div>';
            }
        }

        function createAssetCard(asset) {
            const card = document.createElement('div');
            card.className = `asset-card ${asset.status}`;
            const safeId = asset.name.replace(/[^a-zA-Z0-9]/g, '_');

            const imgPath = BASE_PATH + asset.path;

            // Get existing notes
            const existingNotes = getDeclineNotes(asset.name) || '';

            // Always show buttons for pending/approved/declined
            let actionsHtml = '';
            let notesInputHtml = '';

            if (asset.status === 'pending') {
                notesInputHtml = `
                    <input type="text" id="notes_${safeId}" class="notes-input" 
                           placeholder="Decline reason (optional)..." 
                           value="${existingNotes}"
                           style="width:100%; margin-top:0.5rem; padding:0.3rem; font-size:0.7rem; background:var(--bg-dark); color:var(--text); border:1px solid var(--text-dim); border-radius:3px;">
                `;
                actionsHtml = `
                    <div class="asset-actions">
                        <button class="approve" onclick="approveAsset('${asset.path}')">‚úì Approve</button>
                        <button class="decline" onclick="declineAsset('${asset.path}', '${asset.name}', '${safeId}')">‚úó Decline</button>
                    </div>
                `;
            } else if (asset.status === 'approved') {
                actionsHtml = `
                    <div class="asset-actions">
                        <button class="decline" onclick="declineAssetDirect('${asset.path}', '${asset.name}')">‚úó Decline</button>
                    </div>
                `;
            } else if (asset.status === 'declined') {
                const notesDisplay = existingNotes ? `<div style="font-size:0.7rem; color:var(--accent-yellow); margin-top:0.3rem; font-style:italic;">üìù ${existingNotes}</div>` : '';
                actionsHtml = `
                    ${notesDisplay}
                    <div class="asset-actions">
                        <button class="approve" onclick="approveAsset('${asset.path}')">‚úì Re-approve</button>
                    </div>
                `;
            }

            card.innerHTML = `
                <img class="asset-image" src="${imgPath}" alt="${asset.name}" 
                     onclick="openModal('${imgPath}', '${asset.name}', '${asset.status}')"
                     onerror="this.style.display='none'">
                <div class="asset-info">
                    <div class="asset-name">${asset.name}</div>
                    <span class="asset-status status-${asset.status}">${asset.status}</span>
                    ${notesInputHtml}
                    ${actionsHtml}
                </div>
            `;
            return card;
        }

        async function approveAsset(path) {
            if (!editMode || !rootHandle) {
                alert('Click "Enable Editing" first and select the assets/images folder');
                return;
            }
            await changeStatus(path, 'approved');
        }

        async function declineAsset(path, name, safeId) {
            if (!editMode || !rootHandle) {
                alert('Click "Enable Editing" first and select the assets/images folder');
                return;
            }
            const notesInput = document.getElementById('notes_' + safeId);
            const notes = notesInput ? notesInput.value.trim() : '';
            if (notes) {
                saveDeclineNotes(name, notes);
            }
            await changeStatus(path, 'declined');
        }

        async function declineAssetDirect(path, name) {
            if (!editMode || !rootHandle) {
                alert('Click "Enable Editing" first and select the assets/images folder');
                return;
            }
            const notes = prompt('Decline reason (optional):');
            if (notes) {
                saveDeclineNotes(name, notes);
            }
            await changeStatus(path, 'declined');
        }

        function updateStats() {
            if (!manifest || !manifest.counts) return;

            document.getElementById('statPending').textContent = manifest.counts.pending || 0;
            document.getElementById('statApproved').textContent = manifest.counts.approved || 0;
            document.getElementById('statDeclined').textContent = manifest.counts.declined || 0;
            document.getElementById('statClean').textContent = manifest.counts.clean || 0;
        }

        function openModal(url, name, status) {
            document.getElementById('modalImage').src = url;
            document.getElementById('modalInfo').innerHTML = `<strong>${name}</strong> <span class="asset-status status-${status}">${status}</span>`;
            document.getElementById('imageModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
        }

        async function enableEditMode() {
            try {
                rootHandle = await window.showDirectoryPicker({ mode: 'readwrite' });

                // Also get handle to manifest file for saving
                try {
                    manifestFileHandle = await window.showSaveFilePicker({
                        suggestedName: 'asset_manifest.js',
                        types: [{ description: 'JavaScript', accept: { 'application/javascript': ['.js'] } }]
                    });
                } catch (e) {
                    console.log('No manifest file selected, changes will not persist');
                }

                editMode = true;
                document.getElementById('btnEnableEdit').textContent = '‚úÖ Edit Mode On';
                document.getElementById('btnEnableEdit').classList.add('approve');
                document.getElementById('editInstructions').style.display = 'block';
                renderAssets();
            } catch (err) {
                if (err.name !== 'AbortError') {
                    alert('Error: ' + err.message);
                }
            }
        }

        // Decline modal state
        let pendingDeclinePath = null;
        let pendingDeclineName = null;

        function openDeclineModal(path, name) {
            pendingDeclinePath = path;
            pendingDeclineName = name;
            document.getElementById('declineAssetName').textContent = name;
            document.getElementById('declineNotes').value = getDeclineNotes(name) || '';
            document.getElementById('declineModal').classList.add('active');
        }

        function closeDeclineModal() {
            document.getElementById('declineModal').classList.remove('active');
            pendingDeclinePath = null;
            pendingDeclineName = null;
        }

        async function confirmDecline() {
            const notes = document.getElementById('declineNotes').value.trim();
            if (notes) {
                saveDeclineNotes(pendingDeclineName, notes);
            }
            closeDeclineModal();
            await changeStatus(pendingDeclinePath, 'declined');
        }

        function getDeclineNotes(assetName) {
            const stored = localStorage.getItem('assetDeclineNotes');
            if (!stored) return null;
            const notes = JSON.parse(stored);
            return notes[assetName] || null;
        }

        function saveDeclineNotes(assetName, noteText) {
            const stored = localStorage.getItem('assetDeclineNotes');
            const notes = stored ? JSON.parse(stored) : {};
            notes[assetName] = noteText;
            localStorage.setItem('assetDeclineNotes', JSON.stringify(notes));
        }

        async function changeStatus(path, newStatus) {
            if (!editMode || !rootHandle) {
                alert('Enable edit mode first');
                return;
            }

            const parts = path.split('/');
            const fileName = parts.pop();

            // Navigate to the correct directory
            let dirHandle = rootHandle;
            for (const part of parts) {
                dirHandle = await dirHandle.getDirectoryHandle(part);
            }

            // Calculate new filename
            let baseName = fileName
                .replace('_original', '')
                .replace('_approved', '')
                .replace('_declined', '')
                .replace('_clean', '');

            const ext = baseName.match(/\.(png|jpg|jpeg)$/i)?.[0] || '.png';
            baseName = baseName.replace(/\.(png|jpg|jpeg)$/i, '');
            const newName = `${baseName}_${newStatus}${ext}`;

            try {
                const fileHandle = await dirHandle.getFileHandle(fileName);
                const file = await fileHandle.getFile();
                const content = await file.arrayBuffer();

                const newHandle = await dirHandle.getFileHandle(newName, { create: true });
                const writable = await newHandle.createWritable();
                await writable.write(content);
                await writable.close();

                await dirHandle.removeEntry(fileName);

                // Update manifest in memory
                const asset = manifest.assets.find(a => a.path === path);
                if (asset) {
                    // Update counts
                    if (manifest.counts[asset.status]) manifest.counts[asset.status]--;
                    asset.status = newStatus;
                    asset.name = newName;
                    asset.path = path.replace(fileName, newName);
                    if (!manifest.counts[newStatus]) manifest.counts[newStatus] = 0;
                    manifest.counts[newStatus]++;

                    // Save manifest to file for persistence
                    await saveManifestToFile();

                    // Re-render UI
                    updateStats();
                    renderAssets();
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function saveManifestToFile() {
            if (!manifestFileHandle) return;

            try {
                const writable = await manifestFileHandle.createWritable();
                const content = '// Auto-generated asset manifest\nwindow.ASSET_MANIFEST = ' + JSON.stringify(manifest, null, 2) + ';\n';
                await writable.write(content);
                await writable.close();
            } catch (err) {
                console.log('Could not save manifest:', err.message);
            }
        }

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                renderAssets();
            });
        });

        document.getElementById('btnRefresh').addEventListener('click', loadManifest);
        document.getElementById('btnEnableEdit').addEventListener('click', enableEditMode);
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

        // Load on startup
        loadManifest();
    </script>
</body>

</html>