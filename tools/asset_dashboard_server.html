<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Dashboard (Server Mode)</title>
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-panel: #16213e;
            --bg-card: #0f3460;
            --accent: #e94560;
            --accent-green: #4ecca3;
            --accent-yellow: #ffc107;
            --text: #eaeaea;
            --text-dim: #8892b0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }

        header {
            background: var(--bg-panel);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--accent);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            font-size: 1.5rem;
            color: var(--accent);
        }

        .controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        button.secondary {
            background: var(--bg-card);
            border: 1px solid var(--text-dim);
        }

        button.approve {
            background: var(--accent-green);
        }

        button.decline {
            background: var(--accent);
        }

        .stats {
            display: flex;
            gap: 2rem;
            padding: 0.75rem 2rem;
            background: var(--bg-panel);
            flex-wrap: wrap;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-label {
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        .stat.pending .stat-value {
            color: var(--accent-yellow);
        }

        .stat.approved .stat-value {
            color: var(--accent-green);
        }

        .stat.declined .stat-value {
            color: var(--accent);
        }

        .stat.clean .stat-value {
            color: #64b5f6;
        }

        .sticky-bar {
            position: sticky;
            top: 52px;
            z-index: 99;
            background: var(--bg-dark);
            border-bottom: 1px solid var(--bg-card);
        }

        .filters {
            padding: 0.5rem 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            min-width: 60px;
        }

        .category-filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            border-radius: 20px;
        }

        .filter-btn.active {
            box-shadow: 0 0 0 2px white;
        }

        main {
            padding: 2rem;
        }

        .category {
            margin-bottom: 2rem;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--bg-card);
        }

        .category-title {
            font-size: 1.2rem;
            color: var(--accent);
            text-transform: capitalize;
        }

        .asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }

        .asset-card {
            background: var(--bg-card);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .asset-card.declined {
            opacity: 0.5;
        }

        .asset-card.approved {
            box-shadow: 0 0 0 3px var(--accent-green);
        }

        .asset-card.pending {
            box-shadow: 0 0 0 2px var(--accent-yellow);
        }

        .asset-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: contain;
            background: repeating-conic-gradient(#333 0% 25%, #222 0% 50%) 50% / 20px 20px;
            cursor: pointer;
        }

        .asset-info {
            padding: 0.75rem;
        }

        .asset-name {
            font-size: 0.75rem;
            word-break: break-all;
            margin-bottom: 0.5rem;
            color: var(--text-dim);
        }

        .asset-status {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: var(--accent-yellow);
            color: #000;
        }

        .status-approved {
            background: var(--accent-green);
            color: #000;
        }

        .status-declined {
            background: var(--accent);
            color: #fff;
        }

        .status-clean {
            background: #64b5f6;
            color: #000;
        }

        .status-unknown {
            background: var(--text-dim);
            color: #000;
        }

        .prompt-preview {
            font-size: 0.65rem;
            color: var(--accent-yellow);
            margin-top: 0.3rem;
            font-style: italic;
            cursor: help;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .asset-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .asset-actions button {
            flex: 1;
            padding: 0.3rem;
            font-size: 0.7rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .modal.active {
            display: flex;
        }

        .modal img {
            max-width: 90%;
            max-height: 80%;
            object-fit: contain;
        }

        .modal-info {
            color: white;
            margin-top: 1rem;
            text-align: center;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 2rem;
            color: white;
            cursor: pointer;
        }

        .modal-header {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .modal-toggle {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--text-dim);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .modal-toggle:hover {
            background: var(--accent);
        }

        .comparison-view {
            display: flex;
            gap: 2rem;
            max-width: 95%;
            max-height: 75%;
            align-items: center;
        }

        .comparison-panel {
            flex: 1;
            text-align: center;
        }

        .comparison-panel img {
            max-width: 100%;
            max-height: 60vh;
            object-fit: contain;
            background: repeating-conic-gradient(#333 0% 25%, #444 25% 50%) 50% / 20px 20px;
            border-radius: 4px;
        }

        .comparison-label {
            color: var(--text-dim);
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .comparison-panel.original .comparison-label {
            color: var(--accent-yellow);
        }

        .comparison-panel.clean .comparison-label {
            color: var(--accent-green);
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-dim);
        }

        .error {
            background: var(--accent);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 2rem;
        }

        .server-badge {
            background: var(--accent-green);
            color: #000;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }
    </style>
</head>

<body>
    <header>
        <h1>ü¶ñ Asset Dashboard <span class="server-badge">Server Mode</span></h1>
        <div class="controls">
            <button id="btnTemplates" class="secondary" onclick="showTemplatesView()">üìù Templates</button>
            <button id="btnSync" class="secondary" onclick="showSyncView()">üîó Sync</button>
            <button id="btnRefresh" class="secondary">üîÑ Refresh</button>
        </div>
    </header>

    <div class="stats">
        <div class="stat pending"><span class="stat-value" id="statPending">-</span><span
                class="stat-label">Pending</span></div>
        <div class="stat approved"><span class="stat-value" id="statApproved">-</span><span
                class="stat-label">Approved</span></div>
        <div class="stat declined"><span class="stat-value" id="statDeclined">-</span><span
                class="stat-label">Declined</span></div>
        <div class="stat clean"><span class="stat-value" id="statClean">-</span><span class="stat-label">Clean</span>
        </div>
        <div class="stat" style="color: var(--accent);"><span class="stat-value" id="statMissing">-</span><span
                class="stat-label">Missing</span></div>
        <div class="stat" style="color: #64b5f6;"><span class="stat-value" id="statUnsynced">-</span><span
                class="stat-label">Unsynced</span></div>
    </div>

    <div class="sticky-bar">
        <div class="filters">
            <div class="filter-row">
                <span class="filter-label">Status:</span>
                <button class="filter-btn secondary active" data-filter="all">All</button>
                <button class="filter-btn secondary" data-filter="pending">Pending</button>
                <button class="filter-btn secondary" data-filter="approved">Approved</button>
                <button class="filter-btn secondary" data-filter="declined">Declined</button>
                <button class="filter-btn secondary" data-filter="clean">Clean</button>
                <button class="filter-btn secondary" data-filter="missing" style="border-color: var(--accent);">‚ö†Ô∏è
                    Missing</button>
            </div>
            <div class="filter-row">
                <span class="filter-label">Folder:</span>
                <div class="category-filters" id="categoryFilters"></div>
            </div>
        </div>
    </div>

    <main id="mainContent">
        <div class="loading">Loading assets...</div>
    </main>

    <div class="modal" id="imageModal">
        <span class="modal-close" onclick="closeModal()">√ó</span>
        <div class="modal-header">
            <button class="modal-toggle" id="toggleComparison" onclick="toggleComparisonView()">üìä Compare</button>
        </div>
        <img id="modalImage" src="" alt="Preview" style="display:block;">
        <div class="comparison-view" id="comparisonView" style="display:none;">
            <div class="comparison-panel original">
                <img id="compareOriginal" src="" alt="Original">
                <div class="comparison-label">Original</div>
            </div>
            <div class="comparison-panel clean">
                <img id="compareClean" src="" alt="Clean">
                <div class="comparison-label">Clean</div>
            </div>
        </div>
        <div class="modal-info" id="modalInfo"></div>
    </div>

    <script>
        let manifest = null;
        let declineNotes = {};
        let assetPrompts = {};
        let missingAssets = [];
        let unsyncedAssets = [];
        let currentFilter = 'all';
        let currentCategory = 'all';
        const BASE_PATH = '/images/';

        async function loadManifest() {
            try {
                const resp = await fetch('/api/manifest');
                manifest = await resp.json();
                const notesResp = await fetch('/api/get_notes', { method: 'POST', body: '{}' });
                declineNotes = await notesResp.json();
                const promptsResp = await fetch('/api/get_prompts', { method: 'POST', body: '{}' });
                assetPrompts = await promptsResp.json();
                const missingResp = await fetch('/api/missing_assets', { method: 'POST', body: '{}' });
                const missingData = await missingResp.json();
                missingAssets = missingData.missing || [];
                const unsyncedResp = await fetch('/api/unsynced_assets', { method: 'POST', body: '{}' });
                const unsyncedData = await unsyncedResp.json();
                unsyncedAssets = unsyncedData.unsynced || [];
                buildCategoryFilters();
                renderAssets();
                updateStats();
            } catch (err) {
                document.getElementById('mainContent').innerHTML = `<div class="error"><strong>Server not running.</strong><br>Run: <code>python tools/serve_dashboard.py</code></div>`;
            }
        }

        function buildCategoryFilters() {
            if (!manifest || !manifest.assets) return;

            // Calculate stats per category
            const categoryStats = {};
            manifest.assets.forEach(a => {
                if (!categoryStats[a.category]) {
                    categoryStats[a.category] = { total: 0, clean: 0, pending: 0, approved: 0 };
                }
                categoryStats[a.category].total++;
                if (a.status === 'clean') categoryStats[a.category].clean++;
                if (a.status === 'pending') categoryStats[a.category].pending++;
                if (a.status === 'approved') categoryStats[a.category].approved++;
            });

            const sorted = Object.keys(categoryStats).sort();
            const totalAssets = manifest.assets.length;
            const totalClean = manifest.assets.filter(a => a.status === 'clean').length;

            const container = document.getElementById('categoryFilters');
            container.innerHTML = `<button class="filter-btn secondary ${currentCategory === 'all' ? 'active' : ''}" data-category="all">All (${totalClean}/${totalAssets})</button>`;
            sorted.forEach(cat => {
                const stats = categoryStats[cat];
                const btn = document.createElement('button');
                btn.className = `filter-btn secondary ${currentCategory === cat ? 'active' : ''}`;
                btn.dataset.category = cat;
                btn.textContent = `${cat} (${stats.clean}/${stats.total})`;
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-category]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCategory = cat;
                    renderAssets();
                });
                container.appendChild(btn);
            });

            // Rebind "All Folders" button
            container.querySelector('[data-category="all"]').addEventListener('click', () => {
                document.querySelectorAll('[data-category]').forEach(b => b.classList.remove('active'));
                container.querySelector('[data-category="all"]').classList.add('active');
                currentCategory = 'all';
                renderAssets();
            });
        }

        function renderAssets() {
            const container = document.getElementById('mainContent');
            container.innerHTML = '';

            // Special handling for "missing" filter
            if (currentFilter === 'missing') {
                if (missingAssets.length === 0) {
                    container.innerHTML = '<div class="loading" style="color: var(--accent-green);">‚úì No missing assets! All AssetLoader IDs have valid files.</div>';
                    return;
                }
                const categoryEl = document.createElement('div');
                categoryEl.className = 'category';
                categoryEl.innerHTML = `<div class="category-header"><h2 class="category-title">‚ö†Ô∏è Missing Assets in AssetLoader.js</h2><span style="color: var(--accent)">${missingAssets.length} assets pointing to PH.png</span></div><div class="asset-grid"></div>`;
                container.appendChild(categoryEl);
                const grid = categoryEl.querySelector('.asset-grid');
                missingAssets.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'asset-card declined';
                    card.innerHTML = `<div style="padding:1rem; background:var(--bg-dark); height:100px; display:flex; align-items:center; justify-content:center;"><span style="font-size:2rem;">‚ùì</span></div><div class="asset-info"><div class="asset-name" style="color:var(--accent-yellow);">${item.id}</div><div style="font-size:0.7rem; color:var(--text-dim); margin-top:0.25rem;">Expected: ${item.expectedFile}</div></div>`;
                    grid.appendChild(card);
                });
                return;
            }

            if (!manifest || !manifest.assets) return;

            const categories = {};
            manifest.assets.forEach(asset => {
                if (currentFilter !== 'all' && asset.status !== currentFilter) return;
                if (currentCategory !== 'all' && asset.category !== currentCategory) return;
                if (!categories[asset.category]) categories[asset.category] = [];
                categories[asset.category].push(asset);
            });

            const sortedCategories = Object.keys(categories).sort();
            for (const category of sortedCategories) {
                const assets = categories[category];
                const categoryEl = document.createElement('div');
                categoryEl.className = 'category';
                categoryEl.innerHTML = `<div class="category-header"><h2 class="category-title">${category}</h2><span style="color: var(--text-dim)">${assets.length} assets</span></div><div class="asset-grid"></div>`;
                container.appendChild(categoryEl);
                const grid = categoryEl.querySelector('.asset-grid');
                assets.forEach(asset => grid.appendChild(createAssetCard(asset)));
            }
            if (sortedCategories.length === 0) container.innerHTML = '<div class="loading">No assets match the current filter.</div>';
        }

        function createAssetCard(asset) {
            const card = document.createElement('div');
            card.className = `asset-card ${asset.status}`;
            const safeId = asset.name.replace(/[^a-zA-Z0-9]/g, '_');
            const imgPath = BASE_PATH + asset.path;
            const existingNotes = declineNotes[asset.name] || '';

            let actionsHtml = '';
            let notesInputHtml = '';

            if (asset.status === 'pending') {
                notesInputHtml = `<input type="text" id="notes_${safeId}" class="notes-input" placeholder="Decline reason..." value="${existingNotes}" style="width:100%; margin-top:0.5rem; padding:0.3rem; font-size:0.7rem; background:var(--bg-dark); color:var(--text); border:1px solid var(--text-dim); border-radius:3px;">`;
                actionsHtml = `<div class="asset-actions"><button class="approve" onclick="approveAsset('${asset.path}')">‚úì Approve</button><button class="decline" onclick="declineAsset('${asset.path}', '${asset.name}', '${safeId}')">‚úó Decline</button></div>`;
            } else if (asset.status === 'approved') {
                actionsHtml = `<div class="asset-actions"><button class="decline" onclick="declineAssetPrompt('${asset.path}', '${asset.name}')">‚úó Decline</button></div>`;
            } else if (asset.status === 'declined') {
                const notesDisplay = existingNotes ? `<div style="font-size:0.7rem; color:var(--accent-yellow); margin-top:0.3rem; font-style:italic;">üìù ${existingNotes}</div>` : '';
                actionsHtml = `${notesDisplay}<div class="asset-actions"><button class="approve" onclick="approveAsset('${asset.path}')">‚úì Re-approve</button></div>`;
            } else if (asset.status === 'clean') {
                notesInputHtml = `<input type="text" id="notes_${safeId}" class="notes-input" placeholder="Remake instructions..." value="${existingNotes}" style="width:100%; margin-top:0.5rem; padding:0.3rem; font-size:0.7rem; background:var(--bg-dark); color:var(--text); border:1px solid var(--text-dim); border-radius:3px;">`;
                actionsHtml = `<div class="asset-actions"><button class="secondary" onclick="remakeAsset('${asset.path}', '${asset.name}', '${safeId}')" style="background:#ff9800;">üîÑ Remake</button></div>`;
            }

            // Build base name for prompt lookup: strip status tokens and convert _clean to _original
            let baseNameForPrompt = asset.name.replace('_approved', '').replace('_declined', '');
            // For clean assets, convert _clean to _original since prompts are keyed by original name
            if (baseNameForPrompt.includes('_clean')) {
                baseNameForPrompt = baseNameForPrompt.replace('_clean', '_original');
            }
            const prompt = assetPrompts[baseNameForPrompt] || assetPrompts[asset.name] || '';
            const promptPreview = prompt ? `<div class="prompt-preview" title="${prompt.replace(/"/g, '&quot;')}">üìù ${prompt.substring(0, 40)}${prompt.length > 40 ? '...' : ''}</div>` : '';

            card.innerHTML = `<img class="asset-image" src="${imgPath}" alt="${asset.name}" onclick="openModal('${imgPath}', '${asset.name}', '${asset.status}')" onerror="this.style.display='none'"><div class="asset-info"><div class="asset-name">${asset.name}</div><span class="asset-status status-${asset.status}">${asset.status}</span>${promptPreview}${notesInputHtml}${actionsHtml}</div>`;
            return card;
        }

        async function approveAsset(path) {
            await changeStatus(path, 'approved');
        }

        async function declineAsset(path, name, safeId) {
            const notesInput = document.getElementById('notes_' + safeId);
            const notes = notesInput ? notesInput.value.trim() : '';
            if (notes) await saveNotes(name, notes);
            await changeStatus(path, 'declined');
        }

        async function declineAssetPrompt(path, name) {
            const notes = prompt('Decline reason (optional):');
            if (notes) await saveNotes(name, notes);
            await changeStatus(path, 'declined');
        }

        async function remakeAsset(path, name, safeId) {
            // Get remake instructions from input
            const notesInput = document.getElementById('notes_' + safeId);
            const notes = notesInput ? notesInput.value.trim() : '';

            // Save notes if provided
            if (notes) {
                // Save to decline_notes.json for _original version
                const originalName = name.replace('_clean.png', '_original.png');
                await saveNotes(originalName, notes);
            }

            // Mark the original version as declined
            const originalPath = path.replace('_clean.png', '_original.png');
            const resp = await fetch('/api/remake', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cleanPath: path, notes: notes })
            });
            const result = await resp.json();
            if (result.success) {
                await loadManifest();
            } else {
                alert('Error: ' + result.error);
            }
        }

        async function changeStatus(path, newStatus) {
            const resp = await fetch('/api/change_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path, newStatus })
            });
            const result = await resp.json();
            if (result.success) {
                await loadManifest();
            } else {
                alert('Error: ' + result.error);
            }
        }

        async function saveNotes(assetName, notes) {
            await fetch('/api/save_notes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ assetName, notes })
            });
            declineNotes[assetName] = notes;
        }

        function updateStats() {
            if (!manifest || !manifest.counts) return;
            document.getElementById('statPending').textContent = manifest.counts.pending || 0;
            document.getElementById('statApproved').textContent = manifest.counts.approved || 0;
            document.getElementById('statDeclined').textContent = manifest.counts.declined || 0;
            document.getElementById('statClean').textContent = manifest.counts.clean || 0;
            document.getElementById('statMissing').textContent = missingAssets.length || 0;
            document.getElementById('statUnsynced').textContent = unsyncedAssets.length || 0;
        }

        // Sync View Functions
        function showSyncView() {
            const container = document.getElementById('mainContent');
            container.innerHTML = '';

            if (unsyncedAssets.length === 0) {
                container.innerHTML = '<div class="loading" style="color: var(--accent-green);">‚úì All clean assets are synced to AssetLoader.js!</div>';
                return;
            }

            const categoryEl = document.createElement('div');
            categoryEl.className = 'category';
            categoryEl.innerHTML = `<div class="category-header"><h2 class="category-title">üîó Unsynced Assets</h2><span style="color: #64b5f6">${unsyncedAssets.length} clean files not in AssetLoader.js</span></div><div class="asset-grid"></div>`;
            container.appendChild(categoryEl);
            const grid = categoryEl.querySelector('.asset-grid');

            unsyncedAssets.forEach(item => {
                const card = document.createElement('div');
                card.className = 'asset-card';
                card.style.borderColor = '#64b5f6';
                const safeId = item.file.replace(/[^a-zA-Z0-9]/g, '_');
                card.innerHTML = `
                    <img class="asset-image" src="${BASE_PATH}${item.path}" alt="${item.file}" style="max-height:100px;">
                    <div class="asset-info">
                        <div class="asset-name" style="color:#64b5f6;">${item.file}</div>
                        <div style="font-size:0.7rem; color:var(--text-dim);">Folder: ${item.folder}</div>
                        <input type="text" id="syncId_${safeId}" value="${item.suggestedId}" style="width:100%; margin-top:0.5rem; padding:0.3rem; font-size:0.75rem; background:var(--bg-dark); color:var(--text); border:1px solid var(--text-dim); border-radius:3px;">
                        <div class="asset-actions"><button onclick="syncAsset('${safeId}', '${item.path}')" style="background:#64b5f6;">‚ûï Add to AssetLoader</button></div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        async function syncAsset(safeId, path) {
            const assetId = document.getElementById('syncId_' + safeId).value;
            const resp = await fetch('/api/sync_asset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ assetId, path, category: '' })
            });
            const result = await resp.json();
            if (result.success) {
                await loadManifest();
                showSyncView();
            } else {
                alert('Error: ' + result.error);
            }
        }

        let currentModalAsset = null;
        let isComparisonMode = false;

        function openModal(url, name, status) {
            currentModalAsset = { url, name, status };
            isComparisonMode = false;

            // Show single image view
            document.getElementById('modalImage').style.display = 'block';
            document.getElementById('comparisonView').style.display = 'none';
            document.getElementById('modalImage').src = url;
            document.getElementById('toggleComparison').textContent = 'üìä Compare';

            // Build prompt HTML
            let baseNameForPrompt = name.replace('_approved', '').replace('_declined', '');
            if (baseNameForPrompt.includes('_clean')) {
                baseNameForPrompt = baseNameForPrompt.replace('_clean', '_original');
            }
            const prompt = assetPrompts[baseNameForPrompt] || assetPrompts[name] || '';
            const promptHtml = prompt ? `<div style="margin-top:1rem; max-width:600px; font-size:0.9rem; color:var(--text-dim); background:var(--bg-panel); padding:0.75rem; border-radius:4px; text-align:left;"><strong style="color:var(--accent-yellow);">Prompt:</strong><br>${prompt}</div>` : '';
            document.getElementById('modalInfo').innerHTML = `<strong>${name}</strong> <span class="asset-status status-${status}">${status}</span>${promptHtml}`;
            document.getElementById('imageModal').classList.add('active');
        }

        function toggleComparisonView() {
            if (!currentModalAsset) return;
            isComparisonMode = !isComparisonMode;

            if (isComparisonMode) {
                // Compute original and clean paths
                const { url, name } = currentModalAsset;
                let originalPath, cleanPath;

                if (name.includes('_clean')) {
                    cleanPath = url;
                    originalPath = url.replace('_clean.png', '_approved_original.png');
                } else if (name.includes('_original')) {
                    originalPath = url;
                    cleanPath = url.replace(/_approved_original|_declined_original|_original/g, '_clean');
                } else {
                    originalPath = url;
                    cleanPath = url;
                }

                document.getElementById('modalImage').style.display = 'none';
                document.getElementById('comparisonView').style.display = 'flex';
                document.getElementById('compareOriginal').src = originalPath;
                document.getElementById('compareClean').src = cleanPath;
                document.getElementById('toggleComparison').textContent = 'üñºÔ∏è Single';
            } else {
                document.getElementById('modalImage').style.display = 'block';
                document.getElementById('comparisonView').style.display = 'none';
                document.getElementById('toggleComparison').textContent = 'üìä Compare';
            }
        }

        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
            isComparisonMode = false;
        }

        // Templates View Functions
        let templatesContent = '';
        let templateSaveTimer = null;
        let templateSections = [];
        let assetPromptsJson = {};

        async function showTemplatesView() {
            const container = document.getElementById('mainContent');
            container.innerHTML = '<div class="loading">Loading templates...</div>';

            // Load markdown templates
            const resp = await fetch('/api/get_prompt_templates', { method: 'POST', body: '{}' });
            const data = await resp.json();
            if (!data.success) {
                container.innerHTML = `<div class="error">Error loading templates: ${data.error}</div>`;
                return;
            }
            templatesContent = data.content;
            templateSections = parseAllTemplateSections(templatesContent);

            // Load individual asset prompts from JSON
            try {
                const jsonResp = await fetch('/api/get_prompts', { method: 'POST', body: '{}' });
                assetPromptsJson = await jsonResp.json();
            } catch (e) {
                assetPromptsJson = {};
            }

            container.innerHTML = '';

            // Centered wrapper
            const wrapper = document.createElement('div');
            wrapper.style.cssText = 'max-width:1400px; margin:0 auto;';

            // Header
            const header = document.createElement('div');
            header.style.cssText = 'display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; padding:1rem; background:var(--bg-panel); border-radius:8px;';
            header.innerHTML = `
                <div><h2 style="color:var(--accent); margin:0;">üìù Prompts & Rules</h2><div style="font-size:0.85rem; color:var(--text-dim);">All edits auto-save</div></div>
                <div style="display:flex; gap:1rem; align-items:center;">
                    <span id="templateSaveStatus" style="font-size:0.85rem; color:var(--accent-green);"></span>
                    <button class="secondary" onclick="renderAssets()">‚Üê Back to Assets</button>
                </div>
            `;
            wrapper.appendChild(header);

            // Section: Base Templates (2-column grid)
            const baseSection = document.createElement('div');
            baseSection.innerHTML = '<h3 style="color:var(--text); margin:1rem 0 0.75rem;">üìã Base Templates (from asset_prompts.md)</h3>';
            wrapper.appendChild(baseSection);

            const baseGrid = document.createElement('div');
            baseGrid.style.cssText = 'display:grid; grid-template-columns:repeat(2, 1fr); gap:1rem; margin-bottom:2rem;';

            templateSections.forEach((sec, idx) => {
                const card = document.createElement('div');
                card.style.cssText = 'background:var(--bg-panel); padding:1rem; border-radius:8px; border-left:3px solid var(--accent-yellow);';
                const safeId = sec.name.replace(/[^a-zA-Z0-9]/g, '_');

                card.innerHTML = `
                    <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
                        <span style="font-size:1rem;">${sec.icon}</span>
                        <span style="font-weight:bold; color:var(--text); font-size:0.9rem;">${sec.name}</span>
                    </div>
                    <textarea id="section_${safeId}" data-idx="${idx}" oninput="onSectionEdit(${idx})" 
                        style="width:100%; min-height:80px; background:var(--bg-dark); color:var(--accent-yellow); border:1px solid var(--bg-card); border-radius:4px; padding:0.5rem; font-family:monospace; font-size:0.75rem; resize:vertical; box-sizing:border-box;">${escapeHtml(sec.content)}</textarea>
                `;
                baseGrid.appendChild(card);
            });
            wrapper.appendChild(baseGrid);

            container.appendChild(wrapper);
        }

        function onSectionEdit(idx) {
            const safeId = templateSections[idx].name.replace(/[^a-zA-Z0-9]/g, '_');
            const newValue = document.getElementById('section_' + safeId).value;
            templateSections[idx].content = newValue;

            document.getElementById('templateSaveStatus').textContent = '‚è≥ Saving...';
            document.getElementById('templateSaveStatus').style.color = 'var(--accent-yellow)';

            clearTimeout(templateSaveTimer);
            templateSaveTimer = setTimeout(() => saveAllSections(), 500);
        }

        function onPromptEdit(key) {
            const safeKey = key.replace(/[^a-zA-Z0-9]/g, '_');
            const newValue = document.getElementById('prompt_' + safeKey).value;
            assetPromptsJson[key] = newValue;

            document.getElementById('templateSaveStatus').textContent = '‚è≥ Saving...';
            document.getElementById('templateSaveStatus').style.color = 'var(--accent-yellow)';

            clearTimeout(templateSaveTimer);
            templateSaveTimer = setTimeout(() => saveAllPrompts(), 500);
        }

        async function saveAllSections() {
            let newContent = templatesContent;

            for (const sec of templateSections) {
                const escapedName = sec.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                if (sec.type === 'template') {
                    const regex = new RegExp(`(### ${escapedName}[\\s\\S]*?\`\`\`\\n)[\\s\\S]*?(\`\`\`)`, 'g');
                    newContent = newContent.replace(regex, `$1${sec.content}\n$2`);
                }
            }

            const resp = await fetch('/api/save_prompt_templates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: newContent })
            });
            const result = await resp.json();

            const statusEl = document.getElementById('templateSaveStatus');
            if (result.success) {
                templatesContent = newContent;
                statusEl.textContent = '‚úì Saved';
                statusEl.style.color = 'var(--accent-green)';
            } else {
                statusEl.textContent = '‚úó Error';
                statusEl.style.color = 'var(--accent)';
            }
        }

        async function saveAllPrompts() {
            const resp = await fetch('/api/save_prompts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(assetPromptsJson)
            });
            const result = await resp.json();

            const statusEl = document.getElementById('templateSaveStatus');
            if (result.success) {
                statusEl.textContent = '‚úì Saved';
                statusEl.style.color = 'var(--accent-green)';
            } else {
                statusEl.textContent = '‚úó Error';
                statusEl.style.color = 'var(--accent)';
            }
        }

        function parseAllTemplateSections(content) {
            const sections = [];
            const icons = {
                'Reference Images': 'üñºÔ∏è', 'Base Prompt Structure': 'üìã',
                'Drops': 'üì¶', 'Items': 'üîß', 'Weapons & Tools': '‚öîÔ∏è',
                'Characters': 'üë§', 'Dinosaurs': 'ü¶ñ', 'World Resources': 'üå≤',
                'Consumed Resources': 'üíÄ', 'UI Icons': 'üé®',
                'Forbidden Elements': 'üö´', 'Asset Naming Convention': 'üìõ',
                'Post-Generation Pipeline': '‚öôÔ∏è'
            };

            // Split on both ## and ### headers
            const parts = content.split(/(?=^#{2,3}\s)/m);

            for (const part of parts) {
                const headerMatch = part.match(/^(#{2,3})\s+(.+)/m);
                if (!headerMatch) continue;

                const name = headerMatch[2].trim().replace(/\s*\(.*\)/, '');

                // Skip main title and category wrapper
                if (name === 'Asset Generation Prompt Templates' || name === 'Category Templates') continue;

                const icon = icons[name] || 'üìÑ';

                // Extract template from code block
                const templateMatch = part.match(/```\n([\s\S]*?)```/);
                const template = templateMatch ? templateMatch[1].trim() : '';

                // For sections without code blocks, extract content
                let sectionContent = template;
                if (!template) {
                    const bullets = part.match(/^[-*]\s+.+$/gm);
                    if (bullets) {
                        sectionContent = bullets.join('\n');
                    } else if (name === 'Reference Images') {
                        sectionContent = 'Dinosaurs ‚Üí dino_velociraptor_base_original.png\nOthers ‚Üí world_hero.png';
                    }
                }

                if (sectionContent) {
                    sections.push({ name, icon, type: 'template', content: sectionContent, examples: [], editable: true });
                }
            }

            return sections;
        }

        function escapeHtml(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                renderAssets();
            });
        });

        document.getElementById('btnRefresh').addEventListener('click', loadManifest);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeTemplatesModal();
            }
        });

        loadManifest();
    </script>
</body>

</html>